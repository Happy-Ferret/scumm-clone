$(document).ready(function(){function a(){p=d(),t+=Math.min(1,(p-u)/1e3),b(t),u=p,requestAnimationFrame(a)}function b(){for(var a=0;a<v.length;a++)v[a].move(t);for(var a=0;a<w.length;a++)w[a].move();q.move()}function c(a,b,c,d){var e=Math.min(c/a,d/b);return{width:a*e,height:b*e}}function d(){return window.performance&&window.performance.now?window.performance.now():(new Date).getTime()}function e(a,b,c){return g(a)&&g(b)?a>b?-c:c:0}function f(a,b,c){return"undefined"!=typeof b.x?{x:e(a.x,b.x,c),y:e(a.y,b.y,c)}:void 0}function g(a){return"undefined"!=typeof a}function h(a){this.destX,this.destY,this.speed=2,this.moving=!1,this.curDir={},this.scene=a,this.move=function(){if(this.moving){this.sprite.bottom=this.sprite.getBottomPos(this.x,this.y);var a={x:this.x,y:this.y},b={x:this.destX-this.sprite.w/2,y:this.destY-this.sprite.h},c=f(a,b,this.speed);g(this.curDir.x)||(this.curDir.x=c.x,this.curDir.y=c.y),c.x=this.curDir.x!==c.x?0:c.x,c.y=this.curDir.y!==c.y?0:c.y;var d=this.x+c.x,e=this.y+c.y;this.scene.scrollable&&this.checkSceneEdge(d,e),0!==c.x||0!==c.y?(this.sprite.clear(),this.sprite.draw(d,e),this.zHandler(),this.x=d,this.y=e):(delete this.curDir.x,delete this.curDir.y,this.moving=!1)}},this.zHandler=function(){var a=this.scene.horizonLine,b=this.sprite.bottom;this.sprite.z=Math.abs(1-b.y/a),this.sprite.handleZ()},this.checkSceneEdge=function(){return y-this.scene.padding<=this.sprite.x+this.sprite.w?(this.scene.moving=!0,this.scene.scroll="r",!0):this.sprite.x<=this.scene.padding?(this.scene.moving=!0,this.scene.scroll="l",!0):!1}}function i(){this.items={},this.init=function(){return this.canvas=$("<canvas></canvas>").attr({id:"inv",width:y,height:A}).css({"z-index":9e6,top:z-A}),this.ctx=this.canvas[0].getContext("2d"),this.ctx.fillStyle="rgba(0, 0, 0, 1)",this.ctx.fillRect(0,0,y,A),$("#container").append(this.canvas),this},this.init()}function j(a,b,d){if(this.id=a,this.canvas=$("<canvas></canvas>").attr({id:a,width:y,height:B}).css("z-index",d),this.ctx=this.canvas[0].getContext("2d"),0!==b){this.image={};var e=new Image;e.src=b;var g=this;e.onload=function(){g.image.x=0,g.image.y=0,g.image.src=this,g.image.width=this.width,g.image.height=this.height,g.image.newDM=c(this.width,this.height,1e9,B),g.width=g.image.newDM.width,g.height=g.image.newDM.height,g.draw(g.image.x,g.image.y)}}return this.draw=function(a,b){var c=this.image;g.ctx.drawImage(c.src,0,0,c.width,c.height,a,b,c.newDM.width,c.newDM.height)},this.scroll=function(a){var b=this.image,c=a.x,d=f({x:0,y:0},{x:c,y:0},4),e=b.x+d.x;b.x=e,this.clear(),g.ctx.drawImage(b.src,0,0,b.width,b.height,e,0,b.newDM.width,b.newDM.height)},this.clear=function(){this.ctx.clearRect(0,0,y,z-A)},this}function k(a){h.call(this),this.prototype=new h,this.x=600,this.y=300,this.inventory=new i,this.scene=a,this.speed=4,r=this,this.init=function(){this.sprite=new n(a,150,150),this.sprite.draw(this.x,this.y),v.push(this)},this.init()}function l(a){this.bgLayers=new Array,this.spriteLayers=new Array,this.transporters=new Array,this.moving=!1,this.scrollable,this.padding,this.scroll,this.width=0,this.height=0,this.init=function(){this.getLayers(),this.padding=a.largePadding,this.scrollable=g(a.large)||!a.large?!0:!1,this.persPoint=a.persPoint,this.horizonLine=z-A-a.persPoint.y},this.getLayers=function(){var b=a.imageLayers,c=0;for(var d in b){var e=b[d];if("bg"==e.type){var f=new j("background"+c,e.image,c,this.width,this.height);this.bgLayers.push(f),c++}else if("sprite"==e.type){var f=new j("spritelayer"+c,0,9999,this.width,this.height);this.spriteLayers.push(f),$("#container").append(f.canvas)}}var f=new j("eventLayer",0,99999,this.width,this.height);$("#container").append(f.canvas),s=f,q=this,this.getTransporters(),q.setupControls()},this.getTransporters=function(){var b=a.transporters;for(var c in b){var d=b[c],e=new o(d);w.push(e),this.transporters.push(e)}},this.move=function(){var a,b,c,d={x:0,y:0};if(this.moving){for(var e=0;e<this.bgLayers.length;e++){var f=this.bgLayers[e];"r"==this.scroll&&(d.x=-(f.image.newDM.width-y),b=d.x,a=f.image.x>=d.x),"l"==this.scroll&&(d.x=0,c=d.x,a=f.image.x<=d.x),a?f.scroll(d):this.moving=!1}for(var e=0;e<v.length;e++){var g=v[e];this.moving?(g.destX=b,g.moving=!0):g.moving=!1}for(var e=0;e<this.transporters.length;e++){var g=this.transporters[e];this.moving?(g.destX=b,g.moving=!0):g.moving=!1}}},this.show=function(){for(var a=0;a<this.bgLayers.length;a++)$("#container").append(this.bgLayers[a].canvas)},this.hide=function(){for(var a=0;a<this.bgLayers.length;a++)$("#"+this.bgLayers[a].id).remove()},this.setupControls=function(){$("canvas").on("click",function(a){console.log(a.offsetX+" "+a.offsetY),r.destX=a.offsetX,r.destY=a.offsetY,r.moving=!0})},this.init()}function m(a){this.x,this.y,this.w,this.h,this.z,this.scene=a,this.scaleDiff=1,this.init=function(){},this.handleZ=function(){this.scaleDiff=this.z<=.8||this.z>=.25?this.z:1},this.getBottomPos=function(a,b){var c={};return c.x=a+this.w/2,c.y=b+this.h,c}}function n(a,b,c){m.call(this),this.prototype=new m(a),this.w=b,this.h=c,this.scene=a,this.realH=c,this.realW=b,this.init=function(){this.ctx=a.spriteLayers[0].ctx,this.ctx.fillStyle="rgb(244,244,244)"},this.draw=function(a,b){this.x=a,this.y=b,this.h=parseInt(this.realH*this.scaleDiff),this.w=parseInt(this.realW*this.scaleDiff),this.ctx.fillRect(this.x,this.y,this.w,this.h),this.getBottomPos()},this.clear=function(){this.ctx.clearRect(this.x,this.y,this.w,this.h)},this.init()}function o(a){this.destX,this.destY,this.curDir={},this.speed=4,this.moving=!1,this.init=function(a){this.x=a.x,this.y=a.y,this.origX=this.x,this.origY=this.y,this.w=a.w,this.h=a.h,this.ctx=s.ctx,this.moving=!1,this.spawn(this.x,this.y)},this.spawn=function(a,b){this.ctx.fillStyle="rgb(55,55,244,0.5)",this.ctx.fillRect(a,b,this.w,this.h)},this.clear=function(){this.ctx.clearRect(this.x,this.y,this.w,this.h)},this.move=function(){if(this.moving){var a={x:this.x,y:this.y};if(g(this.destX)||g(this.destY))var b={x:this.destX,y:this.destY};else var b={x:this.origX,y:this.origY};var c=f(a,b,this.speed);g(this.curDir.x)||(this.curDir.x=c.x,this.curDir.y=c.y),c.x=this.curDir.x!==c.x?0:c.x,c.y=this.curDir.y!==c.y?0:c.y;var d=this.x+c.x,e=this.y+c.y;0!==c.x||0!==c.y?(this.clear(),this.spawn(d,e),this.x=d,this.y=e):(delete this.curDir.x,delete this.curDir.y,this.moving=!1)}},this.init(a)}var p,q,r,s,t=0,u=d(),v=new Array,w=new Array;requestAnimationFrame(a);var x={imageLayers:[{type:"bg",image:"assets/scenes/mi1street/street.png"},{type:"transporter"},{type:"sprite"}],large:!0,largePadding:40,persPoint:{x:579,y:259},transporters:[{x:830,y:250,w:45,h:70,title:"Wally's House"}]},y=1024,z=768,A=250,B=z-A,C=new l(x);C.show();new k(C)});