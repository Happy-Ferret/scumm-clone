$(document).ready(function(){function a(){r=d(),u+=Math.min(1,(r-v)/1e3),b(u),v=r,requestAnimationFrame(a)}function b(){for(var a=0;a<w.length;a++)w[a].move(u);for(var a=0;a<x.length;a++)x[a].move();g(s)&&s.move()}function c(a,b,c,d){var e=Math.min(c/a,d/b);return{width:a*e,height:b*e}}function d(){return window.performance&&window.performance.now?window.performance.now():(new Date).getTime()}function e(a,b,c){return g(a)&&g(b)?a>b?-c:c:0}function f(a,b,c){return"undefined"!=typeof b.x?{x:e(a.x,b.x,c),y:e(a.y,b.y,c)}:void 0}function g(a){return"undefined"!=typeof a}function h(a){k.call(this),this.prototype=new k,this.speed=2,this.moving=!1,this.scene=a,this.type="a"}function i(){this.items={},this.textAction,this.textAction="Walk to ",this.init=function(){return this.canvas=$("<canvas></canvas>").attr({id:"inv",width:C,height:E}).css({"z-index":9e6,top:D-E}),this.ctx=this.canvas[0].getContext("2d"),this.ctx.fillStyle="rgba(0, 0, 0, 1)",this.ctx.fillRect(0,0,C,E),$("#container").append(this.canvas),this},this.updateInfoText=function(a){this.clear();var b=this.textAction+a;this.ctx.textAlign="center",this.ctx.fillStyle="white",this.ctx.font="bold 16px Arial",this.ctx.fillText(b,C/2,20)},this.updateCanvas=function(){this.clear(),this.draw()},this.draw=function(){},this.clear=function(){this.ctx.clearRect(0,0,C,50),this.ctx.fillStyle="rgba(0, 0, 0, 1)",this.ctx.fillRect(0,0,C,E)},this.init()}function j(a,b,d){if(this.id=a,this.canvas=$("<canvas></canvas>").attr({id:a,width:C,height:F}).css("z-index",d),this.ctx=this.canvas[0].getContext("2d"),0!==b){this.image={};var e=new Image;e.src=b;var g=this;e.onload=function(){g.image.x=0,g.image.y=0,g.image.src=this,g.image.width=this.width,g.image.height=this.height,g.image.newDM=c(this.width,this.height,1e9,F),g.width=g.image.newDM.width,g.height=g.image.newDM.height,g.draw(g.image.x,g.image.y)}}return this.draw=function(a,b){var c=this.image;g.ctx.drawImage(c.src,0,0,c.width,c.height,a,b,c.newDM.width,c.newDM.height)},this.scroll=function(a){var b=this.image,c=a.x,d=f({x:0,y:0},{x:c,y:0},4),e=b.x+d.x;b.x=e,this.clear(),g.ctx.drawImage(b.src,0,0,b.width,b.height,e,0,b.newDM.width,b.newDM.height)},this.clear=function(){this.ctx.clearRect(0,0,C,D-E)},this}function k(){this.destX,this.destY,this.curDir={},this.move=function(){if(this.moving){var a={x:this.x,y:this.y};"a"==this.type&&(this.destXs=this.destX-this.sprite.w/2,this.destYs=this.destY-this.sprite.h),"t"==this.type&&(g(this.destX)||g(this.destY))?(this.destXs=this.destX,this.destYs=this.destY):"t"==this.type&&(this.destXs=this.origX,this.destYs=this.origY);var b={x:this.destXs,y:this.destYs},c=f(a,b,this.speed);g(this.curDir.x)||(this.curDir.x=c.x,this.curDir.y=c.y),c.x=this.curDir.x!==c.x?0:c.x,c.y=this.curDir.y!==c.y?0:c.y;var d=this.x+c.x,e=this.y+c.y;if("a"==this.type&&this.scene.scrollable&&this.checkSceneEdge(d,e),0!==c.x||0!==c.y)this.sprite.clear(),this.sprite.draw(d,e),this.zHandler(),this.x=d,this.y=e;else if(delete this.curDir.x,delete this.curDir.y,this.moving=!1,"a"==this.type)for(var h=0;h<x.length;h++){var i=x[h];i.intent&&i.transportMe()}}},this.zHandler=function(){if(g(this.scene)){var a=this.scene.horizonLine,b=this.sprite.getBottomPos(this.x,this.y);this.sprite.z=Math.abs(1-b.y/a)}}}function l(a){h.call(this),this.prototype=new h,this.x=a.spawnStart.x,this.y=a.spawnStart.y,this.scene=a,this.speed=4,t=this,this.init=function(){this.sprite=new o(a,a.playerLayer,150,150,"rgb(244,244,244)"),this.sprite.draw(this.x,this.y),w.push(this)},this.checkSceneEdge=function(){return C-this.scene.padding<=this.sprite.x+this.sprite.w?(this.scene.moving=!0,this.scene.scroll="r",!0):this.sprite.x<=this.scene.padding?(this.scene.moving=!0,this.scene.scroll="l",!0):!1},this.init()}function m(a){this.layers=new Array,this.bgLayers=new Array,this.spriteLayers=new Array,this.transportLayers=new Array,this.transporters=new Array,this.hotspots=new Array,this.playerLayer,this.moving=!1,this.scrollable,this.padding,this.scroll,this.width=0,this.height=0,this.init=function(){this.getLayers(),this.padding=a.largePadding,this.scrollable=g(a.large)||!a.large?!0:!1,this.persPoint=a.persPoint,this.spawnStart=a.spawnStart,this.large=a.large,g(a.persPoint)&&(this.horizonLine=D-E-a.persPoint.y);new l(this)},this.getLayers=function(){var b,c=a.imageLayers,d=0;for(var e in c){var f=c[e];"bg"==f.type?(b=new j("background"+d,f.image,d,this.width,this.height),this.bgLayers.push(b)):"sprite"==f.type?(b=new j("spritelayer"+d,0,9999,this.width,this.height),this.spriteLayers.push(b)):"transporter"==f.type?(b=new j("transportlayer"+d,0,9999,this.width,this.height),this.transportLayers.push(b)):"player"==f.type&&(b=new j("player"+d,0,9999,this.width,this.height),this.playerLayer=b),this.layers.push(b),d++}s=this,this.getTransporters()},this.getTransporters=function(){var b=a.transporters;for(var c in b){var d=b[c],e=this.transportLayers[c];this.hotspots.push({x0:d.x,y0:d.y,x1:d.x+d.w,y1:d.y+d.h,name:d.title});var f=new p(d,this,e);x.push(f),this.transporters.push(f)}},this.move=function(){var a,b,c,d,e={x:0,y:0};if(this.moving){for(var f=0;f<this.bgLayers.length;f++){var g=this.bgLayers[f];d=parseInt(g.image.newDM.width),"r"==this.scroll&&(e.x=-(d-C),b=e.x,a=g.image.x>=e.x),"l"==this.scroll&&(e.x=0,c=e.x,a=g.image.x<=e.x),a?g.scroll(e):this.moving=!1}for(var f=0;f<w.length;f++){var h=w[f];this.moving?(h.destX="r"==this.scroll&&2===this.large&&"Player"==h.constructor.name?b+(d-C+(this.padding+100)):"l"==this.scroll&&2===this.large&&"Player"==h.constructor.name?c+(C-(this.padding+100)):b,h.moving=!0):h.moving=!1}for(var f=0;f<this.transporters.length;f++){var h=this.transporters[f];this.moving?(h.destX=b,h.moving=!0):h.moving=!1}}},this.show=function(){for(var a=0;a<this.layers.length;a++)$("#container").append(this.layers[a].canvas);this.setupControls()},this.hide=function(){for(var a=0;a<this.layers.length;a++)$("#"+this.layers[a].id).remove()},this.setupControls=function(){var a=this;$("canvas").on("click",function(b){G&&console.log("Click coordinates: "+b.offsetX+","+b.offsetY),t.destX=b.offsetX,t.destY=b.offsetY;for(var c=0;c<a.transporters.length;c++){var d=a.transporters[c];d.x<=b.offsetX&&b.offsetX<=d.x+d.w&&d.y<=b.offsetY&&b.offsetY<=d.y+d.h?(G&&console.log("Clicked Transporter for "+d.title),d.intent=!0):d.intent=!1}t.moving=!0}),$("canvas").not("#inv").on("mouseout",function(){i.updateCanvas()}),$("canvas").not("#inv").on("mousemove",function(b){y.x=b.offsetX,y.y=b.offsetY;for(var c=0;c<a.hotspots.length;c++){var d=a.hotspots[c];i.updateInfoText(d.x0<=y.x&&y.x<=d.x1&&d.y0<=y.y&&y.y<=d.y1?d.name:"")}})},this.init()}function n(a){this.x,this.y,this.w,this.h,this.z,this.scene=a,this.scaleDiff=1,this.init=function(){},this.handleZ=function(){this.z<=.95&&this.z>=.2&&(this.scaleDiff=this.z)},this.getBottomPos=function(a,b){var c={};return c.x=a+this.w/2,c.y=b+this.h,c}}function o(a,b,c,d,e){n.call(this),this.prototype=new n(a),this.w=c,this.h=d,this.scene=a,this.realH=d,this.realW=c,this.init=function(){this.ctx=b.ctx,this.ctx.fillStyle=e},this.draw=function(a,b){this.getBottomPos(),this.handleZ(),this.x=a,this.y=b,this.h=parseInt(this.realH*this.scaleDiff),this.w=parseInt(this.realW*this.scaleDiff),this.ctx.fillRect(this.x,this.y,this.w,this.h)},this.clear=function(){this.ctx.clearRect(this.x,this.y,this.w,this.h)},this.init()}function p(a,b,c){k.call(this),this.prototype=new k,this.destX,this.destY,this.curDir={},this.speed=4,this.moving=!1,this.intent=!1,this.type="t",this.init=function(a){if(this.x=a.x,this.y=a.y,this.origX=this.x,this.origY=this.y,this.w=a.w,this.h=a.h,this.title=a.title,this.moving=!1,G)var d="rgba(55,55,244,0.5)";else var d="rgba(55,55,244,0)";this.sprite=new o(b,c,this.w,this.h,d),this.sprite.draw(this.x,this.y)},this.transportMe=function(){q.changeScene(a.link),this.intent=!1},this.init(a)}function q(){this.locations=B,this.changeScene=function(a){s.hide();var b=new m(this.locations[a]);b.show()}}var r,s,t,u=0,v=d(),w=new Array,x=new Array,y={};requestAnimationFrame(a);var z={imageLayers:[{type:"bg",image:"assets/scenes/scummbar/scummbar.png"},{type:"transporter"},{type:"player"},{type:"sprite"}],spawnStart:{x:170,y:300},large:2,largePadding:10,transporters:[{x:117,y:280,w:140,h:180,title:"Outside",link:0}]},A={imageLayers:[{type:"bg",image:"assets/scenes/mi1street/street.png"},{type:"transporter"},{type:"player"},{type:"sprite"}],spawnStart:{x:600,y:300},large:1,largePadding:40,persPoint:{x:579,y:259},transporters:[{x:830,y:250,w:45,h:70,title:"SCUMM Bar",link:1}]},B=new Array;B[0]=A,B[1]=z;var C=1024,D=768,E=250,F=D-E,G=!0,i=new i,q=new q,H=new m(A);H.show()});